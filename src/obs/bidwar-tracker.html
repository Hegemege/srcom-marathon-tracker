<html>

<head>
    <style>
        body {
            background-color: rgba(0, 0, 0, 1);
            margin: 0px auto;
            overflow: hidden;
        }

        #main-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        #bidwar-container {
            margin-left: 1em;
            margin-right: 1em;
            margin-bottom: 2em;
            display: flex;
            align-self: center;
            flex-direction: column;
            justify-content: flex-end;
        }

        #bidwar-popup {
            align-self: flex-end;
            position: relative;
            display: inline;
            bottom: 0;
            font-size: 40px;
            font-family: "Futura PT";
        }

        #bidwar-title {
            color: #f9ec0e;
        }

        #bidwar-categories-container {}

        .bidwar-category-row {}

        .bidwar-category-title {
            color: white;
        }

        .bidwar-category-bar {
            height: 40px;
            background-color: white;
        }

        .bidwar-category-donated {
            color: #f9ec0e;
            font-size: 28px;
            right: -30px;
            text-align: right;
        }

        .animated {
            animation-name: bidwar-popup;
            animation-duration: 5s;
            animation-iteration-count: infinite;
        }

        @keyframes bidwar-popup {
            0% {
                left: -20px;
                opacity: 0;
            }

            10% {
                left: 0px;
                opacity: 1;
            }

            90% {
                left: 0px;
                opacity: 1;
            }

            100% {
                left: 10px;
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <div id="main-container">
        <div id="bidwar-container">
            <div id="bidwar-popup">
                <div id="bidwar-title-container">
                    <span id="bidwar-title"></span>
                </div>
                <div id="bidwar-categories-container">

                </div>
            </div>
        </div>
    </div>


    <script type="text/javascript">
        var urlBase = "http://localhost:8090/bidwars?marathon=hek20";
        var fetchInterval = 20 * 1000;
        var bidwarPopupInterval = 5 * 1000;

        var bidwarCache = {};
        var bidwarQueue = []; // Bidwars to be displayed
        var bidwarPopupElement = document.getElementById("bidwar-popup");
        var bidwarTitleElement = document.getElementById("bidwar-title");
        var bidwarCategoriesElement = document.getElementById("bidwar-categories-container");
        var startEpochTimestamp = Date.now() / 1000;

        var runningPopup = null;

        var updateBidwarsData = function () {
            const request = new XMLHttpRequest();

            // Fetches all bidwars since the given timestamp.
            // The script will repeat bidwars from a few hours ago

            request.open("GET", urlBase);
            request.send();
            request.onreadystatechange = e => {
                if (e.target.readyState !== 4 || e.target.status !== 200) return;
                if (request.responseText.length == 0) return;

                let data = JSON.parse(request.responseText);

                // Go through the received bidwars and see if any are missing from the cache
                // If they are, add them to the popup queue
                for (let i = 0; i < data.bidwars.length; i++) {
                    let bidwar = data.bidwars[i];
                    let key = bidwar.title;
                    if (key in bidwarCache) {
                        // Update the categories with new values
                        bidwarCache[key].categories = bidwar.categories;
                        bidwarCache[key].closed = bidwar.closed;
                        continue;
                    }

                    bidwarCache[key] = bidwar;
                    bidwarQueue.push(bidwar);
                }

                if (runningPopup == null) {
                    displayNextBidwars();
                    runningPopup = setInterval(displayNextBidwars, bidwarPopupInterval);
                }
            };
        }

        var displayNextBidwars = function () {
            if (bidwarQueue.length == 0) {
                bidwarPopupElement.classList.remove('animated');
                bidwarTitleElement.innerHTML = "";
                bidwarCategoriesElement.innerHTML = "";
                return;
            }

            // Pull the newest bidwar from the pipe and display it
            // If the bidwar is inactive, pull the next one
            let bidwar = null;
            do {
                bidwar = bidwarQueue.shift();
            } while (bidwarQueue.length > 0 && bidwar != null && bidwar.closed)

            // If we couldn't find a bidwar or the last one was inactive
            // don't show any bidwars for now
            if (bidwar == null || bidwar.closed) {
                return;
            }

            // Add the bidwar back to the end
            bidwarQueue.push(bidwar);

            bidwarPopupElement.classList.add('animated');

            // Update the bidwar title
            bidwarTitleElement.innerHTML = bidwar.title;

            let bidwarCategoryRowTemplate =
                "<div class='bidwar-category-row'><span class='bidwar-category-title'>{0}</span><div class='bidwar-category-bar'><span class='bidwar-category-donated'>{1}</span></div></div>";

            // Loop through all categories and add them under the categories element
            if (bidwar.categories.length == 0) {
                bidwarCategoriesElement.innerHTML =
                    "<div class='bidwar-category-row'><span class='bidwar-category-title'>No bids :(</span></div>";
            } else {
                let rowHTML = "";
                for (let category of bidwar.categories) {

                }
                bidwarCategoriesElement.innerHTML = rowHTML;
            }
        }

        updateBidwarsData(); // Update immediately on page load
        setInterval(updateBidwarsData, fetchInterval); // Update after the given interval
    </script>
</body>

</html>